<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OCR Cleaner Pro | Gemini Partner</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://js.puter.com/v2/"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

body{
    background:#020617;
    font-family:'Plus Jakarta Sans',sans-serif;
    color:#f1f5f9;
}
.glass{
    background:rgba(15,23,42,.65);
    backdrop-filter:blur(12px);
    border:1px solid rgba(255,255,255,.08);
}
.log{
    font-family:'JetBrains Mono',monospace;
}
</style>
</head>

<body class="p-6 md:p-10">

<div class="max-w-6xl mx-auto">

<header class="flex justify-between items-center mb-8">
<div>
<h1 class="text-3xl font-extrabold">OCR <span class="text-indigo-400">Cleaner</span> Pro</h1>
<p class="text-slate-400 text-sm">Corrected AI Implementation</p>
</div>
<div class="flex gap-3">
<button id="startBtn" class="px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-bold transition">START</button>
<button id="stopBtn" disabled class="px-6 py-3 rounded-xl bg-slate-700 font-bold opacity-40 transition">STOP</button>
</div>
</header>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

<div class="lg:col-span-4 space-y-5">
<div class="glass p-6 rounded-2xl">
<label class="text-xs text-slate-400 uppercase">Input Text File</label>
<input id="fileInput" type="file" accept=".txt"
class="mt-2 w-full bg-slate-900 p-2 rounded border border-slate-700"/>
</div>

<div class="glass p-6 rounded-2xl grid grid-cols-2 gap-4">
<div>
<label class="text-xs uppercase text-slate-400">Qs / Chunk</label>
<input id="qsPerChunk" type="number" value="10"
class="w-full mt-1 bg-slate-900 p-2 rounded border border-slate-700"/>
</div>
<div>
<label class="text-xs uppercase text-slate-400">Delay (ms)</label>
<input id="delay" type="number" value="1000"
class="w-full mt-1 bg-slate-900 p-2 rounded border border-slate-700"/>
</div>
</div>

<div class="grid grid-cols-2 gap-4">
<div class="glass p-4 rounded-xl text-center">
<div id="statTotal" class="text-2xl font-bold">-</div>
<div class="text-xs text-slate-400">Total Chunks</div>
</div>
<div class="glass p-4 rounded-xl text-center">
<div id="statDone" class="text-2xl font-bold text-emerald-400">0</div>
<div class="text-xs text-slate-400">Processed</div>
</div>
</div>
</div>

<div class="lg:col-span-8 space-y-4">
<div class="glass p-4 rounded-xl flex items-center gap-4">
<div class="w-full bg-slate-800 rounded-full h-2">
<div id="progressBar" class="bg-indigo-500 h-2 rounded-full w-0 transition-all duration-500"></div>
</div>
<span id="progressText" class="text-sm">0%</span>
</div>

<div class="glass rounded-2xl overflow-hidden">
<div class="px-4 py-2 bg-slate-900 text-xs uppercase text-slate-400 flex justify-between">
<span>Live Output</span>
<span id="statusIndicator" class="text-indigo-400 animate-pulse hidden">AI is thinking...</span>
</div>
<div id="log" class="log h-[55vh] overflow-y-auto p-4 text-sm leading-relaxed"></div>
</div>
</div>
</div>
</div>

<script>
lucide.createIcons();

(function(){
    const fileInput = document.getElementById("fileInput");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const logBox = document.getElementById("log");
    const statTotal = document.getElementById("statTotal");
    const statDone = document.getElementById("statDone");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const statusIndicator = document.getElementById("statusIndicator");

    let stopFlag = false;
    let correctedChunks = [];
    let GLOBAL_EXAM_TAG = "";

    function log(msg, type="info"){
        const d = document.createElement("div");
        d.className = "mb-6 p-3 rounded " + (type==="ai" ? "bg-slate-900/50 text-emerald-300 border-l-4 border-emerald-500" : "text-indigo-300 italic");
        d.textContent = msg;
        logBox.appendChild(d);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function splitIntoQuestions(text, qs){
        // Improved split to capture Q.No even with spaces
        const parts = text.split(/(?=Q\.No\s*[:.-]?\s*\d+)/gi);
        const header = parts[0];
        const qsns = parts.slice(1);
        let chunks = [];
        for(let i=0; i<qsns.length; i+=qs){
            let c = qsns.slice(i, i+qs).join("\n\n");
            if(i===0 && header.length > 5) c = header + "\n" + c;
            chunks.push(c);
        }
        return chunks;
    }

    async function sendToAI(content){
        statusIndicator.classList.remove('hidden');
        const prompt = `
        You are an expert OCR Correction Engine.
        TASK: Clean the following OCR text and format it into clear Hindi questions.

        STRICT RULES:
        1. Keep ONLY the Hindi text. Remove all English translations/text.
        2. FIX OCR errors (misspelled Hindi words).
        3. FORMAT: Each question must start with its original "Q.No: XX".
        4. ANSWER: Mention the correct answer clearly.
        5. MANDATORY TAG: Append exactly "${GLOBAL_EXAM_TAG}" at the end of every single question.
        6. MULTI-STATEMENT: For Assertion/Reason or Statement questions (1, 2, 3), do NOT skip any statements. List them all.
        7. OUTPUT: No intro, no outro, no explanations. Just the cleaned questions.

        TEXT TO PROCESS:
        ${content}
        `;

        try {
            const r = await puter.ai.chat(prompt, {
                model: "gpt-4o-mini", // Recommended for better instruction following
                max_tokens: 3500
            });
            statusIndicator.classList.add('hidden');
            return r.message.content;
        } catch (e) {
            statusIndicator.classList.add('hidden');
            return "AI_ERROR: " + e.message;
        }
    }

    startBtn.onclick = async () => {
        const file = fileInput.files[0];
        if(!file) { alert("Please select a file first!"); return; }

        startBtn.disabled = true;
        stopBtn.disabled = false;
        startBtn.classList.add('opacity-40');
        stopBtn.classList.remove('opacity-40');
        stopFlag = false;
        logBox.innerHTML = "";
        correctedChunks = [];

        const text = await file.text();

        // Robust Exam Tag Detection
        const tagMatch = text.match(/(SSC|UP|RRB|IBPS|UPSC|Exam).*?\d{4}.*?Shift-?\d+/i) || 
                         text.match(/SSC\s*SICPO.*?2025/i);
        
        GLOBAL_EXAM_TAG = tagMatch ? tagMatch[0].trim() : "SSC SICPO 2025";
        log(`Detected Exam Tag: ${GLOBAL_EXAM_TAG}`);

        const qs = parseInt(document.getElementById("qsPerChunk").value) || 10;
        const chunks = splitIntoQuestions(text, qs);
        statTotal.textContent = chunks.length;

        for(let i=0; i<chunks.length; i++){
            if(stopFlag) { log("STOPPED BY USER"); break; }

            log(`ðŸ”„ Processing Chunks ${i+1}/${chunks.length}...`);
            let out = await sendToAI(chunks[i]);

            if(out.includes("AI_ERROR")) {
                log("Error occurred, retrying in 3 seconds...");
                await new Promise(r => setTimeout(r, 3000));
                i--; continue;
            }

            log(out, "ai");
            correctedChunks.push(out);

            statDone.textContent = i+1;
            const p = Math.round(((i+1)/chunks.length)*100);
            progressBar.style.width = p + "%";
            progressText.textContent = p + "%";

            await new Promise(r => setTimeout(r, document.getElementById("delay").value));
        }

        if(correctedChunks.length > 0){
            const blob = new Blob([correctedChunks.join("\n\n")], {type: "text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `Cleaned_${GLOBAL_EXAM_TAG.replace(/\s+/g, '_')}.txt`;
            a.click();
            log("âœ… Task Completed! File Downloaded.");
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
        startBtn.classList.remove('opacity-40');
        stopBtn.classList.add('opacity-40');
    };

    stopBtn.onclick = () => { stopFlag = true; };
})();
</script>
</body>
</html>
