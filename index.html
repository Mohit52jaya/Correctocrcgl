<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>SSC GK Batch Classifier (Ollama)</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #020617;
    color: #e5e7eb;
    padding: 20px;
}

h2 { color: #38bdf8; }

input[type=file] {
    margin-top: 10px;
}

button {
    padding: 10px 18px;
    font-size: 15px;
    margin-top: 10px;
    cursor: pointer;
}

.stat {
    margin-top: 10px;
    font-weight: bold;
}

#progressWrap {
    margin-top: 15px;
}

#progressBarBg {
    width: 100%;
    background: #1e293b;
    height: 12px;
    border-radius: 6px;
    overflow: hidden;
}

#progressBar {
    width: 0%;
    height: 100%;
    background: #38bdf8;
}

#log {
    margin-top: 15px;
    background: #020617;
    border: 1px solid #334155;
    padding: 10px;
    height: 220px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 13px;
}

.category-box {
    margin-top: 15px;
    border: 1px solid #334155;
    padding: 8px;
    max-height: 180px;
    overflow-y: auto;
    background: #020617;
}

hr {
    border: none;
    border-top: 1px solid #334155;
    margin: 8px 0;
}
</style>
</head>

<body>

<h2>SSC GK Batch Classifier (Local Ollama)</h2>

<input type="file" id="fileInput" accept=".txt"><br>
<button onclick="start()">Start Processing</button>

<div class="stat" id="status">Waitingâ€¦</div>
<div class="stat" id="counter"></div>

<div id="progressWrap">
    <div>Progress: <span id="progressText">0%</span></div>
    <div id="progressBarBg">
        <div id="progressBar"></div>
    </div>
</div>

<div id="log"></div>

<h3>Category-wise Live Output</h3>
<div id="categories"></div>

<script>
// ðŸ”´ CHANGE IP IF REQUIRED
const OLLAMA_URL = "http://192.168.29.235:11434/api/generate";

// Delay between requests (safe for Ollama)
const DELAY = 700;

const categories = [
    "History",
    "Geography",
    "Polity",
    "Economy",
    "Science",
    "Current Affairs",
    "Miscellaneous"
];

let results = {};
let totalQuestions = 0;

categories.forEach(c => results[c] = []);

// -------- QUESTION SPLITTER --------
// Splits by exam-date bracket ending
function splitQuestions(text) {
    const blocks = text
        .split(/\)\s*\n/)
        .map(b => b.trim())
        .filter(b => b.length > 30);

    return blocks.map(b => b + ")");
}

// -------- RENDER CATEGORY BOXES --------
function renderCategoryBoxes() {
    const container = document.getElementById("categories");
    container.innerHTML = "";

    categories.forEach(cat => {
        const div = document.createElement("div");
        div.className = "category-box";
        div.innerHTML = "<b>" + cat + "</b><hr>" +
            results[cat].join("<hr>");
        container.appendChild(div);
    });
}

// -------- OLLAMA CLASSIFIER --------
async function classify(question) {

    const prompt =
"You are an SSC exam content editor.\n\n" +
"Classify the following question into ONE category ONLY:\n" +
categories.join("\n") + "\n\n" +
"Rules:\n" +
"- Output only the category name\n" +
"- If unclear, choose Miscellaneous\n\n" +
"Question:\n" + question;

    const payload = {
        model: "llama3:8b",
        prompt: prompt,
        stream: false
    };

    const res = await fetch(OLLAMA_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const json = await res.json();
    return json.response.trim();
}

// -------- MAIN PROCESS --------
async function start() {

    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("Please select a .txt file");
        return;
    }

    categories.forEach(c => results[c] = []);
    document.getElementById("log").textContent = "";
    document.getElementById("categories").innerHTML = "";
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("progressText").textContent = "0%";

    const text = await file.text();
    const questions = splitQuestions(text);

    totalQuestions = questions.length;
    document.getElementById("status").textContent = "Processing startedâ€¦";

    for (let i = 0; i < questions.length; i++) {

        const q = questions[i];

        document.getElementById("status").textContent =
            "Processing " + (i + 1) + " / " + totalQuestions;

        try {
            let cat = await classify(q);
            if (!results[cat]) cat = "Miscellaneous";
            results[cat].push(q);

            document.getElementById("log").textContent +=
                (i + 1) + ". [" + cat + "]\n" + q + "\n\n";

        } catch (e) {
            results["Miscellaneous"].push(q);
            document.getElementById("log").textContent +=
                (i + 1) + ". [ERROR â†’ Miscellaneous]\n" + q + "\n\n";
        }

        document.getElementById("counter").textContent =
            "Processed: " + (i + 1);

        const percent = Math.round(((i + 1) / totalQuestions) * 100);
        document.getElementById("progressBar").style.width = percent + "%";
        document.getElementById("progressText").textContent = percent + "%";

        renderCategoryBoxes();
        await new Promise(r => setTimeout(r, DELAY));
    }

    document.getElementById("status").textContent = "Completed âœ“";
    downloadFile();
}

// -------- DOWNLOAD FINAL FILE --------
function downloadFile() {

    let output = "";

    categories.forEach(cat => {
        output += "===== " + cat.toUpperCase() + " =====\n\n";
        results[cat].forEach((q, i) => {
            output += (i + 1) + ". " + q + "\n\n";
        });
    });

    const blob = new Blob([output], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "SSC_GK_Classified.txt";
    a.click();
}
</script>

</body>
</html>
