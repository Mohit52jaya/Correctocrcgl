<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OCR Cleaner Pro | Mohit</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://js.puter.com/v2/"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

body{
    background:#020617;
    font-family:'Plus Jakarta Sans',sans-serif;
    color:#f1f5f9;
}
.glass{
    background:rgba(15,23,42,.65);
    backdrop-filter:blur(12px);
    border:1px solid rgba(255,255,255,.08);
}
.log{
    font-family:'JetBrains Mono',monospace;
}
</style>
</head>

<body class="p-6 md:p-10">

<div class="max-w-6xl mx-auto">

<header class="flex justify-between items-center mb-8">
<div>
<h1 class="text-3xl font-extrabold">OCR <span class="text-indigo-400">Cleaner</span> Pro</h1>
<p class="text-slate-400 text-sm">Engineered by Mohit</p>
</div>
<div class="flex gap-3">
<button id="startBtn" class="px-6 py-3 rounded-xl bg-indigo-600 font-bold">START</button>
<button id="stopBtn" disabled class="px-6 py-3 rounded-xl bg-slate-700 font-bold opacity-40">STOP</button>
</div>
</header>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

<!-- LEFT -->
<div class="lg:col-span-4 space-y-5">

<div class="glass p-6 rounded-2xl">
<label class="text-xs text-slate-400 uppercase">Input Text File</label>
<input id="fileInput" type="file" accept=".txt"
class="mt-2 w-full bg-slate-900 p-2 rounded"/>
</div>

<div class="glass p-6 rounded-2xl grid grid-cols-2 gap-4">
<div>
<label class="text-xs uppercase text-slate-400">Qs / Chunk</label>
<input id="qsPerChunk" type="number" value="15"
class="w-full mt-1 bg-slate-900 p-2 rounded"/>
</div>
<div>
<label class="text-xs uppercase text-slate-400">Delay (ms)</label>
<input id="delay" type="number" value="1200"
class="w-full mt-1 bg-slate-900 p-2 rounded"/>
</div>
</div>

<div class="grid grid-cols-2 gap-4">
<div class="glass p-4 rounded-xl text-center">
<div id="statTotal" class="text-2xl font-bold">-</div>
<div class="text-xs text-slate-400">Total Chunks</div>
</div>
<div class="glass p-4 rounded-xl text-center">
<div id="statDone" class="text-2xl font-bold text-emerald-400">0</div>
<div class="text-xs text-slate-400">Processed</div>
</div>
</div>

</div>

<!-- RIGHT -->
<div class="lg:col-span-8 space-y-4">

<div class="glass p-4 rounded-xl flex items-center gap-4">
<div class="w-full bg-slate-800 rounded-full h-2">
<div id="progressBar" class="bg-indigo-500 h-2 rounded-full w-0"></div>
</div>
<span id="progressText" class="text-sm">0%</span>
</div>

<div class="glass rounded-2xl overflow-hidden">
<div class="px-4 py-2 bg-slate-900 text-xs uppercase text-slate-400">
Live Output
</div>
<div id="log" class="log h-[55vh] overflow-y-auto p-4 text-sm"></div>
</div>

</div>

</div>
</div>

<script>
lucide.createIcons();

(function(){

const fileInput = document.getElementById("fileInput");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const logBox = document.getElementById("log");
const statTotal = document.getElementById("statTotal");
const statDone = document.getElementById("statDone");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

let stopFlag = false;
let correctedChunks = [];
let GLOBAL_EXAM_TAG = "";

/* ---------- UTIL ---------- */

function log(msg, type="info"){
const d=document.createElement("div");
d.className="mb-4 whitespace-pre-wrap "+(type==="ai"?"text-cyan-400":"text-indigo-300");
d.textContent=msg;
logBox.appendChild(d);
logBox.scrollTop=logBox.scrollHeight;
}

function splitIntoQuestions(text, qs){
const parts=text.split(/(?=Q\.No\s*:)/gi);
const header=parts[0];
const qsns=parts.slice(1);
let chunks=[];
for(let i=0;i<qsns.length;i+=qs){
let c=qsns.slice(i,i+qs).join("\n\n");
if(i===0) c=header+"\n"+c;
chunks.push(c);
}
return chunks;
}

/* ---------- AI ---------- */

async function sendToAI(content){
const prompt=`
You are a COMPETITIVE EXAM ANSWERING ENGINE.

MANDATORY RULES:
1. Fix OCR errors in hindi only.
2. NEVER remove statements from statement/Assertion questions.
3. Answer every question using options.
4. Use this exam tag for ALL questions:
${GLOBAL_EXAM_TAG || "NO_EXAM_TAG"}
5. Append the exam tag to EVERY QUESTION.
6. Do NOT invent dates.
7. Remove english text from output.
8. Do NOT write explanations.
9. Each question must start with original Q.No.
10. Preserve MCQ format for statement / assertion questions.

TEXT:
${content}
`;

try{
const r=await puter.ai.chat(prompt,{
model:"deepseek/deepseek-v3.2",
max_tokens:3000
});
return r.message.content;
}catch{
return "AI_ERROR";
}
}

/* ---------- START ---------- */

startBtn.onclick=async()=>{
const file=fileInput.files[0];
if(!file) return;

startBtn.disabled=true;
stopBtn.disabled=false;
stopFlag=false;
logBox.innerHTML="";
correctedChunks=[];

const text=await file.text();

/* DETECT EXAM TAG ONCE */
const match=text.match(
/(SSC\s*CGL\s*Tier\s*\d+.*?\(Shift-?\d+\))|((SSC|UP|RRB|IBPS|NABARD).*?\d{1,2}\s[A-Za-z]{3,}\s\d{4}.*?\(Shift-?\d+\))/i
);
if(match) GLOBAL_EXAM_TAG=match[0].replace(/\s+/g," ").trim();

const qs=parseInt(document.getElementById("qsPerChunk").value)||15;
const chunks=splitIntoQuestions(text,qs);
statTotal.textContent=chunks.length;

for(let i=0;i<chunks.length;i++){
if(stopFlag) break;

log(`Processing chunk ${i+1}/${chunks.length}`);
let out=await sendToAI(chunks[i]);

/* FINAL SAFETY NET */
if(GLOBAL_EXAM_TAG && !out.includes(GLOBAL_EXAM_TAG)){
out=out.replace(
/(Q\.No\s*\d+.*?\?)/g,
`$1 (${GLOBAL_EXAM_TAG})`
);
}

log(out,"ai");
correctedChunks.push(out);

statDone.textContent=i+1;
const p=Math.round(((i+1)/chunks.length)*100);
progressBar.style.width=p+"%";
progressText.textContent=p+"%";

await new Promise(r=>setTimeout(r,document.getElementById("delay").value));
}

/* DOWNLOAD */
const blob=new Blob([correctedChunks.join("\n\n")],{type:"text/plain"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="Cleaned_Exam_Paper.txt";
a.click();

startBtn.disabled=false;
stopBtn.disabled=true;
};

stopBtn.onclick=()=>stopFlag=true;

})();
</script>

</body>
</html>
