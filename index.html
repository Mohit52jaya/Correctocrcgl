<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OCR Fast Batch | Delhi Police</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://js.puter.com/v2/"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
body { background: #020617; font-family: 'Plus Jakarta Sans', sans-serif; color: #f1f5f9; }
.glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
.log-entry { border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 0.8rem 0; line-height: 1.6; }
.active-file { border-left: 4px solid #6366f1; background: rgba(99, 102, 241, 0.1); }
</style>
</head>
<body class="p-4 md:p-10">
<div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tight">DP <span class="text-indigo-400">Fast</span> Cleaner</h1>
            <p class="text-slate-400 text-sm font-bold uppercase tracking-widest">Multi-Threaded Batch Processing</p>
        </div>
        <div class="flex gap-3">
            <button id="startBtn" class="px-8 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-bold shadow-lg shadow-indigo-500/20 transition-all">START BATCH</button>
            <button id="stopBtn" disabled class="px-8 py-3 rounded-xl bg-slate-700 font-bold opacity-40 transition-all">STOP</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-4 space-y-5">
            <div class="glass p-6 rounded-2xl">
                <label class="text-xs text-indigo-300 font-bold uppercase">Select Text Files</label>
                <input id="fileInput" type="file" accept=".txt" multiple class="mt-3 w-full bg-slate-900/50 p-2 rounded-xl border border-slate-700 outline-none file:bg-indigo-600 file:border-0 file:rounded file:text-white file:px-2"/>
            </div>
            <div class="glass p-5 rounded-2xl text-center border-b-4 border-indigo-500">
                <div id="statTag" class="text-xs font-mono text-indigo-300 break-words h-12 flex items-center justify-center italic">Ready...</div>
                <div class="text-[10px] text-slate-500 uppercase mt-2">Active Exam Tag</div>
            </div>
            <div class="glass p-4 rounded-2xl">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Queue Status</h3>
                <div id="fileQueue" class="space-y-2 max-h-48 overflow-y-auto text-[11px]"></div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-4">
            <div class="glass p-4 rounded-2xl flex items-center gap-4">
                <div class="flex-1">
                    <div class="flex justify-between mb-1"><span class="text-[10px] uppercase text-slate-400 font-bold">Progress</span><span id="progressPercent" class="text-[10px] font-bold">0%</span></div>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden">
                        <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
                    </div>
                </div>
            </div>
            <div class="glass rounded-2xl overflow-hidden shadow-2xl">
                <div id="log" class="h-[60vh] overflow-y-auto p-6 text-[14px] whitespace-pre-wrap selection:bg-indigo-500/30"></div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    const fileInput = document.getElementById("fileInput");
    const fileQueue = document.getElementById("fileQueue");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const logBox = document.getElementById("log");
    const statTag = document.getElementById("statTag");
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");

    let stopFlag = false;

    fileInput.onchange = () => {
        fileQueue.innerHTML = "";
        Array.from(fileInput.files).forEach((file, idx) => {
            const item = document.createElement("div");
            item.className = "p-2 rounded bg-slate-800/50 flex justify-between border border-white/5";
            item.id = `file-item-${idx}`;
            item.innerHTML = `<span>${file.name}</span><span class="status-icon">‚è≥</span>`;
            fileQueue.appendChild(item);
        });
    };

    function log(content, isAI = false) {
        const div = document.createElement("div");
        div.className = isAI ? "log-entry text-emerald-300" : "text-indigo-400 text-[11px] py-1 border-l-2 border-indigo-500 pl-2 my-1";
        div.textContent = content;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- Improved Exam Tag Detection ---
    function detectTag(text) {
        const lines = text.split('\n').slice(0, 100); 
        let examName = "Delhi Police Constable";
        let date = "";
        let shift = "";

        for (let line of lines) {
            if (line.includes("Test Date")) date = line.split(":")[1]?.trim();
            if (line.includes("Shift")) {
                const shiftMatch = line.match(/\(Shift-?\s*(\d+)\)/i);
                shift = shiftMatch ? `Shift-${shiftMatch[1]}` : line.split(":")[1]?.trim();
            }
        }
        
        if (date && shift) return `${examName} ${date} ${shift}`;
        return "Delhi Police Constable Exam 2025";
    }

    async function processFile(file, idx) {
        document.getElementById(`file-item-${idx}`).classList.add('active-file');
        const text = await file.text();
        const tag = detectTag(text);
        statTag.textContent = tag;
        
        log(`Processing: ${file.name}`);

        const questions = text.split(/(?=Q\.No\s*[:.-]?\s*\d+)/gi).filter(q => q.length > 20);
        let chunks = [];
        for(let i=0; i<questions.length; i+=10) chunks.push(questions.slice(i, i+10).join("\n\n"));

        // Speed Boost: Process 3 chunks at the same time
        const concurrency = 3;
        let outputData = new Array(chunks.length);
        
        for (let i = 0; i < chunks.length; i += concurrency) {
            if (stopFlag) return null;
            
            const batch = chunks.slice(i, i + concurrency).map(async (chunk, subIdx) => {
                const prompt = `You are a Hindi Exam Formatter. 
                RULES:
                RULES:
            1. LANGUAGE: Use ONLY Hindi. Remove English translations.
            2. STRUCTURE: Start every question on a NEW LINE with its original Q.No.
            3. TAG: Append "(${tag})" at the end of every question.
           4. FORMAT: Q.No XX: Question ‚Äî **Correct Answer** (exam date) . This format should follow in every question except STATEMENT QUESTIONS. There should be no options 
          Example : - Q.No 76: ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§ú‡•ç‡§û‡§æ‡§®‡§™‡•Ä‡§† ‡§™‡•Å‡§∞‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§µ‡§ø‡§ú‡•á‡§§‡§æ ‡§Æ‡§π‡§ø‡§≤‡§æ ‡§≤‡•á‡§ñ‡§ø‡§ï‡§æ ‡§π‡•à? ‚Äî ‡§Æ‡§π‡§æ‡§¶‡•á‡§µ‡•Ä ‡§µ‡§∞‡•ç‡§Æ‡§æ‡•§ (Delhi Police Constable 28 Nov 2025 Shift-3)
            4. STATEMENT QUESTIONS: For 'Kathan' (Statement) or Assertion questions, you MUST list all statements (Statement 1, Statement 2, etc.) clearly on separate sub-lines. Do not skip any statement.
Example - Q.No 93: ‡§≠‡§æ‡§∞‡§§ ‡§ï‡•á ‡§™‡•á‡§ü‡•ç‡§∞‡•ã‡§≤‡§ø‡§Ø‡§Æ ‡§≠‡§Ç‡§°‡§æ‡§∞ ‡§ï‡§ø‡§® ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§π‡•à‡§Ç?
I. ‡§Ö‡§∏‡§Æ ‡§ï‡•Ä ‡§Ö‡§µ‡§∏‡§æ‡§¶‡•Ä ‡§ò‡§æ‡§ü‡§ø‡§Ø‡§æ‡§Å‡•§
II. ‡§Ö‡§∞‡§¨ ‡§∏‡§æ‡§ó‡§∞ ‡§ï‡§æ ‡§Ö‡§™‡§§‡§ü‡•Ä‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•§
‚Äî I ‡§î‡§∞ II ‡§¶‡•ã‡§®‡•ã‡§Ç‡•§ (Delhi Police Constable 28 Nov 2025 Shift-3)
            5. Exam date is mandatory in every question and exam date is same for continuous 50 questions and exam changes after 50 questions check exam date tag            

                
                TEXT: ${chunk}`;

                try {
                    const res = await puter.ai.chat(prompt);
                    outputData[i + subIdx] = res.message.content.trim();
                    log(outputData[i + subIdx], true);
                } catch (e) {
                    log("‚ö†Ô∏è AI Error, retrying...");
                    i -= concurrency; // Retry this batch
                }
            });

            await Promise.all(batch);
            
            const p = Math.round(((i + concurrency) / chunks.length) * 100);
            progressBar.style.width = Math.min(p, 100) + "%";
            progressPercent.textContent = Math.min(p, 100) + "%";
        }

        const blob = new Blob([outputData.filter(d => d).join("\n\n")], {type: "text/plain"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Cleaned_${file.name}`;
        a.click();

        document.getElementById(`file-item-${idx}`).querySelector('.status-icon').textContent = "‚úÖ";
        document.getElementById(`file-item-${idx}`).classList.remove('active-file');
        return true;
    }

    startBtn.onclick = async () => {
        const files = fileInput.files;
        if(!files.length) return;
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        stopFlag = false;
        logBox.innerHTML = "";

        for(let i=0; i<files.length; i++) {
            if(stopFlag) break;
            await processFile(files[i], i);
            await new Promise(r => setTimeout(r, 1000));
        }
        
        log("üèÅ BATCH COMPLETE.");
        startBtn.disabled = false;
        stopBtn.disabled = true;
    };

    stopBtn.onclick = () => { stopFlag = true; };
})();
</script>
</body>
</html>
