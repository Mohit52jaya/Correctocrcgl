<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OCR Cleaner Pro | Delhi Police Updated</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://js.puter.com/v2/"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
body { background: #020617; font-family: 'Plus Jakarta Sans', sans-serif; color: #f1f5f9; }
.glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
.log-entry { border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 1rem 0; line-height: 1.8; }
</style>
</head>
<body class="p-4 md:p-10">
<div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tight">OCR <span class="text-indigo-400">Cleaner</span> Pro</h1>
            <p class="text-slate-400 text-sm font-bold uppercase tracking-widest">Delhi Police & SSC Specialist</p>
        </div>
        <div class="flex gap-3">
            <button id="startBtn" class="px-8 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-bold shadow-lg shadow-indigo-500/20 transition-all">START</button>
            <button id="stopBtn" disabled class="px-8 py-3 rounded-xl bg-slate-700 font-bold opacity-40 transition-all">STOP</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-4 space-y-5">
            <div class="glass p-6 rounded-2xl">
                <label class="text-xs text-indigo-300 font-bold uppercase">Upload Answer Key (.txt)</label>
                <input id="fileInput" type="file" accept=".txt" class="mt-3 w-full bg-slate-900/50 p-2 rounded-xl border border-slate-700 focus:border-indigo-500 outline-none"/>
            </div>
            <div class="glass p-5 rounded-2xl text-center border-b-4 border-indigo-500">
                <div id="statTag" class="text-xs font-mono text-indigo-300 break-words h-12 flex items-center justify-center italic">Waiting for file...</div>
                <div class="text-[10px] text-slate-500 uppercase mt-2">Detected Exam Tag</div>
            </div>
            <div class="glass p-5 rounded-2xl text-center">
                <div id="statDone" class="text-3xl font-bold text-emerald-400">0</div>
                <div class="text-xs text-slate-400 mt-1 uppercase">Chunks Done</div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-4">
            <div class="glass p-4 rounded-2xl">
                <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                    <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-500"></div>
                </div>
            </div>
            <div class="glass rounded-2xl overflow-hidden shadow-2xl">
                <div id="log" class="h-[60vh] overflow-y-auto p-6 text-[15px] whitespace-pre-wrap leading-relaxed"></div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    const fileInput = document.getElementById("fileInput");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const logBox = document.getElementById("log");
    const statTag = document.getElementById("statTag");
    const statDone = document.getElementById("statDone");
    const progressBar = document.getElementById("progressBar");

    let stopFlag = false;
    let GLOBAL_TAG = "";

    function log(content, isAI = false) {
        const div = document.createElement("div");
        div.className = isAI ? "log-entry text-emerald-300" : "text-indigo-400 text-xs py-1";
        div.textContent = content;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- à¤¯à¤¹à¤¾à¤ à¤¸à¥à¤§à¤¾à¤° à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾ à¤¹à¥ˆ (Detecting Delhi Police & Date correctly) ---
    function detectTag(text) {
        const lines = text.split('\n').slice(0, 50); // à¤¶à¥à¤°à¥à¤†à¤¤à¥€ à¤²à¤¾à¤‡à¤¨à¥‹à¤‚ à¤®à¥‡à¤‚ à¤¢à¥‚à¤‚à¤¢à¥‡à¤‚
        let level = "";
        let date = "";
        let shift = "";

        for(let line of lines) {
            if(line.includes("Exam Level")) level = line.split(":")[1]?.trim();
            if(line.includes("Test Date")) date = line.split(":")[1]?.trim();
            if(line.includes("Shift")) shift = line.split(":")[1]?.trim();
        }

        if(level && date) {
            // "Constable (Executive) Male and Female in Delhi Police Examination, 2025" à¤•à¥‹ à¤›à¥‹à¤Ÿà¤¾ à¤•à¤°à¥‡à¤‚
            const cleanLevel = level.replace("Male and Female in ", "").replace("Examination,", "").trim();
            return `${cleanLevel} ${date} ${shift}`;
        }
        
        // Fallback à¤…à¤—à¤° à¤Šà¤ªà¤° à¤µà¤¾à¤²à¤¾ à¤«à¥‡à¤² à¤¹à¥‹ à¤œà¤¾à¤
        const fallback = text.match(/(Constable.*?Delhi Police|SSC).*?\d{4}.*?Shift-?\d+/i);
        return fallback ? fallback[0] : "SSC Exam 2025";
    }

    startBtn.onclick = async () => {
        const file = fileInput.files[0];
        if(!file) return alert("Select File!");

        const text = await file.text();
        GLOBAL_TAG = detectTag(text);
        statTag.textContent = GLOBAL_TAG;
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        logBox.innerHTML = "";
        stopFlag = false;

        const questions = text.split(/(?=Q\.No\s*[:.-]?\s*\d+)/gi).filter(q => q.length > 20);
        let chunks = [];
        for(let i=0; i<questions.length; i+=10) chunks.push(questions.slice(i, i+10).join("\n\n"));

        for(let i=0; i<chunks.length; i++) {
            if(stopFlag) break;
            log(`ðŸ”„ Processing Batch ${i+1}...`);
            
            const prompt = `You are a professional Hindi Exam Formatter. 
            RULES:
            1. Output in HINDI only.
            2. Start every question on a NEW LINE.
            3. Append "(${GLOBAL_TAG})" at the end of every question.
            4. Format: Q.No XX: [Question] â€” **Correct Answer**
            TEXT: ${chunks[i]}`;

            try {
                const res = await puter.ai.chat(prompt);
                const cleaned = res.message.content.trim();
                log(cleaned, true);
                statDone.textContent = i+1;
                progressBar.style.width = ((i+1)/chunks.length)*100 + "%";
            } catch (e) { log("Error in AI call"); }
        }
        startBtn.disabled = false;
    };

    stopBtn.onclick = () => { stopFlag = true; };
})();
</script>
</body>
</html>
